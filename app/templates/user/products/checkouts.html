<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Darumadrop+One&family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
</head>
<style>
.form-select:focus, 
.form-control:focus {
    border-color: #CB997E !important;
    border-width: 2px;
    outline: 0 !important;
    box-shadow: none !important; 
}

.btn-outline-secondary{
    border-color: #CB997E !important;
    color: #CB997E !important;
}

.btn-check:checked + .btn-outline-secondary {
    background-color: #CB997E !important;
    border-color: #CB997E !important;
    color: white !important;
}

.form-select, 
.form-control, 
.btn-outline-secondary {
    transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
}
</style>
<body>
    <nav class="navbar navbar-expand-lg px-4" style="background-color: #6a705d; z-index: 1030;">
        <div class="container-fluid">
            <a class="navbar-brand mx-auto d-flex align-items-center pt-0 pb-1" href="/">
                <span class="logo-text" style="color: white;">Wagging Wonders</span>
            </a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row" style="min-height: calc(100vh - 56px);"> <div class="col-md-7 py-5 px-5">
                <p class="text-muted">{{ email }}</p>
                <hr>
                <form action="{{ url_for('user.process_order') }}" method="POST" enctype="multipart/form-data">
                    <h5 class="fw-bold mb-3">Delivery Address</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-md-12">
                            <label class="form-label small fw-bold">Region</label>
                            <select id="region" class="form-select" required>
                                <option value="" selected disabled>Select Region</option>
                            </select>
                            <input type="hidden" name="region" id="region_name">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label small fw-bold">Province</label>
                            <select id="province" class="form-select" disabled required>
                                <option value="" selected disabled>Select Province</option>
                            </select>
                            <input type="hidden" name="province" id="province_name">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label small fw-bold">City / Municipality</label>
                            <select id="city" class="form-select" disabled required>
                                <option value="" selected disabled>Select City</option>
                            </select>
                            <input type="hidden" name="city" id="city_name">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label small fw-bold">Barangay</label>
                            <select id="barangay" class="form-select" disabled required>
                                <option value="" selected disabled>Select Barangay</option>
                            </select>
                            <input type="hidden" name="barangay" id="barangay_name">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label small fw-bold">Postal Code</label>
                            <input type="text" name="postal" class="form-control" placeholder="1234" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">House No. / Street / Subd.</label>
                            <input type="text" name="address" class="form-control" placeholder="123 Example St." required>
                        </div>
                    </div>

                    <h5 class="fw-bold mb-3 mt-4">Payment Method</h5>
                    <div class="w-100 mb-3" role="group">
                        <input type="radio" class="btn-check" name="payment" id="gcash" value="Gcash" required>
                        <label class="btn btn-outline-secondary" for="gcash">Gcash</label>

                        <input type="radio" class="btn-check" name="payment" id="maya" value="Maya">
                        <label class="btn btn-outline-secondary" for="maya">Maya</label>

                        <input type="radio" class="btn-check" name="payment" id="cod" value="COD">
                        <label class="btn btn-outline-secondary" for="cod">Cash on Delivery</label>
                    </div>

                    <div class="mb-4">
                        <label class="form-label small text-muted">Proof of Payment (Required for Gcash/Maya)</label>
                        <input type="file" name="image" class="form-control">
                    </div>

                    <input type="hidden" name="selected_item_ids" value="{{ request.args.get('items') }}">
                    
                    <button type="submit" class="btn w-100 py-3 fw-bold text-white" style="background-color: #CB997E; border-radius: 8px;">
                        Complete Checkout
                    </button>
                </form>
            </div>

            <div class="col-md-5 py-5 px-4 d-flex flex-column sticky-top" >
                <div style="position: sticky; top: 100px; bottom: 120px;">
                    <div class="p-4 rounded shadow-sm d-flex flex-column" style="background-color: #f8f9fa;">
                        <h5 class="fw-bold mb-4">Order Summary</h5>
                        
                        <div class="flex-grow-1" style="max-height: 50vh; overflow-y: auto; overflow-x: hidden; padding-right: 10px;">
                            {% for item in products %}
                            <div class="d-flex align-items-center my-3">
                                <div class="position-relative">
                                    <img src="{{ url_for('static', filename=item.image) }}" class="rounded border" style="width: 64px; height: 64px; object-fit: cover;">
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary">
                                        {{ item.quantity }}
                                    </span>
                                </div>
                                <div class="ms-3 flex-grow-1">
                                    <p class="mb-0 fw-semibold small text-black">{{ item.name }}</p>
                                </div>
                                <div class="text-end">
                                    <p class="mb-0 small text-black">₱{{ "{:,.2f}".format(item.price * item.quantity) }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="mt-auto">
                            <hr>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal</span>
                                <span>₱{{ "{:,.2f}".format(total) }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Shipping</span>
                                <span class="text-success">FREE</span>
                            </div>
                            <div class="d-flex justify-content-between mt-3 h5 fw-bold">
                                <span>Total</span>
                                <span style="color: #CB997E;">₱{{ "{:,.2f}".format(total) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const selects = {
            region: document.getElementById('region'),
            province: document.getElementById('province'),
            city: document.getElementById('city'),
            barangay: document.getElementById('barangay')
        };

        const hiddens = {
            region: document.getElementById('region_name'),
            province: document.getElementById('province_name'),
            city: document.getElementById('city_name'),
            barangay: document.getElementById('barangay_name')
        };

        // Only run address logic if the region select exists (Checkout Page)
        if (selects.region) {
            const updateHidden = (key) => {
                if (selects[key] && selects[key].selectedIndex > 0) {
                    hiddens[key].value = selects[key].options[selects[key].selectedIndex].text;
                }
            };

            // Load Regions
            fetch('/get_regions')
                .then(res => res.json())
                .then(data => {
                    data.forEach(item => {
                        selects.region.add(new Option(item.region_name, item.region_code));
                    });
                })
                .catch(err => console.error("Region Load Error:", err));

            // Listeners for changes
            selects.region.onchange = () => {
                updateHidden('region');
                selects.province.disabled = false;
                selects.province.innerHTML = '<option value="" selected disabled>Select Province</option>';
                fetch('/get_provinces')
                    .then(res => res.json())
                    .then(data => {
                        data.filter(p => p.region_code === selects.region.value)
                            .forEach(p => selects.province.add(new Option(p.province_name, p.province_code)));
                    });
            };

            selects.province.onchange = () => {
                updateHidden('province');
                selects.city.disabled = false;
                selects.city.innerHTML = '<option value="" selected disabled>Select City</option>';
                fetch('/get_cities')
                    .then(res => res.json())
                    .then(data => {
                        data.filter(c => c.province_code === selects.province.value)
                            .forEach(c => selects.city.add(new Option(c.city_name, c.city_code)));
                    });
            };

            selects.city.onchange = () => {
                updateHidden('city');
                selects.barangay.disabled = false;
                selects.barangay.innerHTML = '<option value="" selected disabled>Select Barangay</option>';
                fetch('/get_barangays')
                    .then(res => res.json())
                    .then(data => {
                        data.filter(b => b.city_code === selects.city.value)
                            .forEach(b => selects.barangay.add(new Option(b.brgy_name, b.brgy_code)));
                    });
            };

            selects.barangay.onchange = () => updateHidden('barangay');
        }
    });
</script>
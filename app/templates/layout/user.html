<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Wagging Wonders</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Darumadrop+One&family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-modern">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <div class="logo-container">
                    <i class="bi bi-heart-pulse-fill me-2 logo-icon"></i>
                    <span class="logo-text">Wagging Wonders</span>
                </div>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto nav-links-center">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('user.home') }}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('user.product_listing', category='all') }}">Shop</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('user.product_listing', category='all') }}">Foods</a>
                    </li>
                </ul>

                <div class="d-flex align-items-center nav-actions">
                    <ul class="navbar-nav d-flex flex-row gap-4">
                        {% if session.get('user_id') and session.get('role') == 'user' %}
                        
                        <li class="nav-item">
                            <a class="nav-link nav-icon-link" href="#" data-bs-toggle="offcanvas" data-bs-target="#wishlistSidebar" title="Wishlist">
                                <i class="bi bi-heart"></i>
                            </a>
                        </li>

                        <li class="nav-item position-relative">
                            <a href="#" class="nav-link nav-icon-link" data-bs-toggle="offcanvas" data-bs-target="#cartSidebar"
                                aria-controls="cartSidebar" title="Shopping Cart">
                                <i class="bi bi-cart3"></i>
                                <span id="cart-count" class="cart-badge">
                                    {{ cart_count or 0 }}
                                </span>
                            </a>
                        </li>
                        
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle user-dropdown" href="#" id="profileDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle me-1"></i>
                                {{ session.get('name') or 'User' }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-modern" aria-labelledby="profileDropdown">
                                <li><a class="dropdown-item" href="{{ url_for('user.order_history', status='all') }}">
                                    <i class="bi bi-bag-check me-2"></i>My Orders</a></li>
                                <li><a class="dropdown-item" href="#" data-bs-toggle="offcanvas" data-bs-target="#reviewsSidebar">
                                    <i class="bi bi-star me-2"></i>My Reviews</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="{{ url_for('user.user_logout') }}">
                                    <i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                        
                        {% else %}
                        <li class="nav-item">
                            <a class="nav-link btn-signin" href="/">
                                Sign in
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Wishlist Sidebar (Offcanvas) -->
    <div class="offcanvas offcanvas-end d-flex flex-column sidebar-modern" tabindex="-1" id="wishlistSidebar" aria-labelledby="wishlistSidebarLabel">
        <div class="offcanvas-header sidebar-header">
            <div class="d-flex align-items-center">
                <i class="bi bi-heart-fill me-2 sidebar-icon"></i>
                <h5 class="logo-text mb-0 sidebar-title" id="wishlistSidebarLabel">My Wishlist</h5>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>

        <div class="sidebar-section-header">
            <span class="section-label">SAVED PRODUCTS</span>
        </div>

        <div class="offcanvas-body flex-grow-1 sidebar-body" id="wishlist-items">
        </div>

        <div class="offcanvas-footer sidebar-footer">
            <div class="d-grid gap-2">
                <button class="btn btn-primary-modern py-3 fw-semibold" data-bs-dismiss="offcanvas">
                    <i class="bi bi-arrow-left me-2"></i>Continue Shopping
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Sidebar (Offcanvas) -->
    <div class="offcanvas offcanvas-end d-flex flex-column sidebar-modern" tabindex="-1" id="cartSidebar" aria-labelledby="cartSidebarLabel">
        <div class="offcanvas-header sidebar-header">
            <div class="d-flex align-items-center">
                <i class="bi bi-cart3 me-2 sidebar-icon"></i>
                <h5 class="logo-text mb-0 sidebar-title" id="cartSidebarLabel">Your Cart</h5>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>

        <div class="sidebar-section-header">
            <span class="section-label">PRODUCT</span>
            <span class="section-label">TOTAL</span>
        </div>

        <div class="offcanvas-body flex-grow-1 sidebar-body" id="cart-items">
        </div>

        <div class="offcanvas-footer sidebar-footer">
            <div class="cart-total-wrapper mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="cart-total-label">Estimated Total:</span>
                    <span class="cart-total-amount">₱<span id="cart-total-price">0.00</span></span>
                </div>
            </div>
            
            <div class="d-grid gap-2">
                <button class="btn btn-primary-modern py-3 fw-semibold" id="buy-selected" style="display: none;">
                    <i class="bi bi-bag-check me-2"></i>Checkout Selected
                </button>
                <button class="btn btn-outline-danger-modern py-2" id="remove-selected" style="display: none;">
                    <i class="bi bi-trash me-2"></i>Remove Selected
                </button>
            </div>
        </div>
    </div>


    <!-- Order Confirmation Modal -->
    <div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content modal-modern">
                <div class="modal-header modal-header-modern">
                    <h5 class="modal-title" id="orderModalLabel">
                        <i class="bi bi-receipt me-2"></i>Order Confirmation
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body modal-body-modern">
                    <h5 class="mb-4 modal-section-title">
                        <i class="bi bi-bag-check me-2"></i>Items to be purchased:
                    </h5>
                    <div id="order-details" class="order-details-wrapper">
                        <!-- Order items will be dynamically filled here -->
                    </div>
                    <hr class="modal-divider">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <p class="mb-0 modal-total-label"><strong>Total Amount:</strong></p>
                        <p class="mb-0 modal-total-amount"><strong>₱<span id="total-price">0</span></strong></p>
                    </div>
                    <p class="modal-payment-info">
                        <i class="bi bi-credit-card me-2"></i><strong>Payment Method:</strong> Cash on Delivery
                    </p>
                </div>
                <div class="modal-footer modal-footer-modern">
                    <button type="button" class="btn btn-outline-secondary-modern px-4 py-2" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary-modern px-4 py-2" id="confirmOrder">
                        <i class="bi bi-check-circle me-2"></i>Place Order
                    </button>
                </div>
            </div>
        </div>
    </div>



    <div class="offcanvas offcanvas-end sidebar-modern" tabindex="-1" id="ordersSidebar" aria-labelledby="ordersSidebarLabel">
        <div class="offcanvas-header sidebar-header">
            <div class="d-flex align-items-center">
                <i class="bi bi-bag-check me-2 sidebar-icon"></i>
                <h5 class="offcanvas-title sidebar-title" id="ordersSidebarLabel">My Orders</h5>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
        </div>
        <div class="offcanvas-body sidebar-body">
            <!-- Order details will be loaded here dynamically -->
            <div id="my-orders">
                <!-- Ongoing and completed orders -->
            </div>
        </div>
    </div>

    <!-- Reviews Sidebar -->
    <div class="offcanvas offcanvas-end sidebar-modern" tabindex="-1" id="reviewsSidebar" aria-labelledby="reviewsSidebarLabel">
        <div class="offcanvas-header sidebar-header">
            <div class="d-flex align-items-center">
                <i class="bi bi-star me-2 sidebar-icon"></i>
                <h5 class="offcanvas-title sidebar-title" id="reviewsSidebarLabel">My Reviews</h5>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
        </div>
        <div class="offcanvas-body sidebar-body">
            <div id="my-reviews">
                <!-- Reviews will be loaded here dynamically -->
            </div>
        </div>
    </div>



    <main class="">
        {% block content %}{% endblock %}
    </main>

    {% block scripts %}{% endblock %}

    <!-- Snackbar container -->
    <div id="snackbar-container" aria-live="polite" aria-atomic="true"></div>

</body>

</html>

<script>

    // --- 1. GLOBAL FUNCTIONS ---
    
    window.loadWishlistItems = function() {
        fetch("/wishlist/items") // You will create this route next
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('wishlist-items');
            container.innerHTML = ''; 

            if (data.length > 0) {
                data.forEach(item => {
                    container.innerHTML += `
                        <div class="sidebar-item-card">
                            <div class="sidebar-item-content">
                                <img src="/static/${item.image}" class="sidebar-item-image" alt="${item.name}">
                                <div class="sidebar-item-details">
                                    <p class="sidebar-item-name">${item.name}</p>
                                    <p class="sidebar-item-price">₱${item.price.toLocaleString()}</p>
                                    <div class="sidebar-item-actions">
                                        <button class="btn btn-sm btn-primary-modern" onclick="addToCartFromWishlist(${item.product_id})" title="Add to Cart">
                                            <i class="bi bi-cart-plus me-1"></i>Add to Cart
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger-modern" onclick="toggleWishlist(${item.product_id}, null)" title="Remove">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });
            } else {
                container.innerHTML = `<div class="sidebar-empty-state">
                    <i class="bi bi-heart sidebar-empty-icon"></i>
                    <p class="sidebar-empty-text">Your wishlist is empty</p>
                    <p class="sidebar-empty-subtext">Start adding products you love!</p>
                </div>`;
            }
        });
    };

    // Function to update the number shown in the PDP input field
    window.adjustPDPQuantity = function(change) {
        const qtyInput = document.getElementById('pdp-quantity');
        if (!qtyInput) return;
        
        let currentQty = parseInt(qtyInput.value) || 1;
        let maxQty = parseInt(qtyInput.getAttribute('max')) || 999;
        let newQty = currentQty + change;

        // Prevent quantity from going below 1 or above max
        if (newQty >= 1 && newQty <= maxQty) {
            qtyInput.value = newQty;
        } else if (newQty < 1) {
            qtyInput.value = 1;
        } else if (newQty > maxQty) {
            qtyInput.value = maxQty;
        }
    };

    // Function to call the UPSERT logic with the chosen quantity
    window.addToCartFromPDP = function(productId) {
        const qty = parseInt(document.getElementById('pdp-quantity').value);
        
        // Use your existing upSert function
        // mode 'add' ensures it adds to the current cart quantity
        window.upSert(productId, qty, 'add');
        
        // Optional: Reset quantity to 1 after adding
        document.getElementById('pdp-quantity').value = 1;
    };
    // Helper to move item to cart and refresh both sidebars
    window.addToCartFromWishlist = function(productId) {
        upSert(productId, 1, 'add'); 
    };

    // This function handles BOTH single trash icon clicks AND the bulk remove button
    // UPDATED: Now updates ALL hearts on the page instantly after toggle
    window.toggleWishlist = function(productId, btnElement) {
        fetch(`/wishlist/toggle/${productId}`, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) throw new Error('Not logged in');
            return response.json();
        })
        .then(data => {
            // 1. Update the Icon on the Product Card (if btnElement exists)
            if (btnElement) {
                const icon = btnElement.querySelector('i');
                if (data.status === 'added') {
                    icon.classList.replace('bi-heart', 'bi-heart-fill');
                } else {
                    icon.classList.replace('bi-heart-fill', 'bi-heart');
                }
            }

            // 2. Update ALL heart icons for this product ID on the page
            const isWishlisted = data.is_wishlisted;
            const newIconClass = isWishlisted ? 'bi-heart-fill' : 'bi-heart';
            document.querySelectorAll(`i[data-product-id="${productId}"]`).forEach(icon => {
                icon.classList.remove('bi-heart', 'bi-heart-fill');
                icon.classList.add(newIconClass);
            });

            // 3. Check if the Wishlist Sidebar is currently open
            const wishlistSidebar = document.getElementById('wishlistSidebar');
            if (wishlistSidebar && wishlistSidebar.classList.contains('show')) {
                // Re-fetch the list so the item disappears from the sidebar immediately
                loadWishlistItems();
            }

            // Notify user
            if (data.status === 'added') {
                window.notify('Added to wishlist', 'success');
            } else {
                window.notify('Removed from wishlist', 'info');
            }
        })
        .catch(err => {
            window.notify("Please login to manage your wishlist!", 'warning');
            window.location.href = "/login";
        });
    };

    window.removeCartItems = function(idList) {
        if (!idList || idList.length === 0) {
            window.notify("Please select items to remove.", 'warning');
            return;
        }

        if (confirm("Are you sure you want to remove the selected item(s)?")) {
            $.ajax({
                url: '/cart/items/remove-selected',
                method: 'POST',
                // Ensure data key matches the Python getlist('selected_items[]')
                data: { 'selected_items[]': idList }, 
                success: function () {
                    loadCartItems();
                    window.notify('Removed item(s) from cart', 'info');
                },
                error: function () {
                    window.notify('Failed to remove items.', 'danger');
                }
            });
        }
    };

    // Wrapper for the trash icon onclick attribute
    window.removeSingleItem = function(id) {
        window.removeCartItems([id]); // Wraps the single ID in an array
    };

    // The Single Source of Truth for Cart Changes
    window.upSert = function(productId, qty, mode) {
        let formData = new FormData();
        formData.append('product_id', productId);
        formData.append('quantity', qty);
        formData.append('mode', mode); // 'add' (increment) or 'set' (overwrite)

        fetch('/cart/items/upsert', { 
            method: 'POST', 
            body: formData 
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadCartItems(); // Refresh the UI
                window.notify(mode === 'add' ? 'Added to cart' : 'Updated quantity', 'success');
            } else {
                window.notify(data.error || "Action failed", 'danger');
            }
        })
        .catch(err => console.error("Cart Error:", err));
    }

    // Logic for Sidebar +/- Buttons
    window.updateQuantity = function(cartId, productId, action) {
        const quantityInput = document.getElementById('quantity-' + cartId);
        if (!quantityInput) return;

        let currentQuantity = parseInt(quantityInput.value);
        let newQuantity = (action === 'increase') ? currentQuantity + 1 : currentQuantity - 1;

        if (newQuantity >= 1) {
            // We use 'set' mode here to overwrite the DB with the new exact number
            window.upSert(productId, newQuantity, 'set');
        }
    };

    window.toggleSelection = function() {
        const selectedCount = document.querySelectorAll('.select-item:checked').length;
        const removeButton = document.getElementById('remove-selected');
        const buyButton = document.getElementById('buy-selected');
        
        if(removeButton && buyButton) {
            const displayStyle = selectedCount > 0 ? 'inline-block' : 'none';
            removeButton.style.display = displayStyle;
            buyButton.style.display = displayStyle;
        }
    };

    window.getSelectedItems = function() {
        return Array.from(document.querySelectorAll('.select-item:checked')).map(cb => cb.getAttribute('data-id'));
    };

    // --- 2. LOADERS ---

    function loadCartItems() {
        $.ajax({
            url: "{{ url_for('user.cart_items') }}",
            method: 'GET',
            success: function (response) {
                const cartItemsContainer = document.getElementById('cart-items');
                const cartCountBadge = document.getElementById('cart-count');
                const totalDisplay = document.getElementById('cart-total-price');
                
                let total = 0;
                let itemCount = 0;
                cartItemsContainer.innerHTML = ''; 
                
                if (response && response.length > 0) {
                    response.forEach(item => {
                        total += item.price * item.quantity;
                        itemCount += item.quantity;
                        const imagePath = `/static/${item.image}`; 
                        cartItemsContainer.innerHTML += ` 
                            <div class="sidebar-item-card">
                                <div class="form-check cart-checkbox">
                                    <input type="checkbox" class="form-check-input select-item" data-id="${item.id}" onchange="toggleSelection()">
                                </div>
                                <div class="sidebar-item-content">
                                    <img src="${imagePath}" class="sidebar-item-image" alt="${item.name}">
                                    <div class="sidebar-item-details">
                                        <p class="sidebar-item-name">${item.name}</p>
                                        <p class="sidebar-item-price-unit">₱${item.price.toLocaleString()}</p>
                                        <div class="sidebar-item-controls">
                                            <div class="quantity-control">
                                                <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.product_id}, 'decrease')" title="Decrease">
                                                    <i class="bi bi-dash"></i>
                                                </button>
                                                <input type="text" id="quantity-${item.id}" class="quantity-input" value="${item.quantity}" readonly>
                                                <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.product_id}, 'increase')" title="Increase">
                                                    <i class="bi bi-plus"></i>
                                                </button>
                                            </div>
                                            <button class="btn-remove-item" onclick="removeSingleItem(${item.id})" title="Remove item">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sidebar-item-total">
                                        <span class="item-total-price">₱${(item.price * item.quantity).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                    </div>
                                </div>
                            </div>`;
                    });
                    totalDisplay.textContent = total.toLocaleString('en-US', {minimumFractionDigits: 2});
                    cartCountBadge.textContent = itemCount;
                } else {
                    cartItemsContainer.innerHTML = `<div class="sidebar-empty-state">
                        <i class="bi bi-cart-x sidebar-empty-icon"></i>
                        <p class="sidebar-empty-text">Your cart is empty</p>
                        <p class="sidebar-empty-subtext">Add some products to get started!</p>
                    </div>`;
                    totalDisplay.textContent = "0.00";
                    cartCountBadge.textContent = "0";
                }
                toggleSelection();
            }
        });
    }

    // --- 3. DOM READY ---

    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. CART & WISHLIST INITIALIZATION ---
        loadCartItems();

        const wishlistSidebar = document.getElementById('wishlistSidebar');
        wishlistSidebar?.addEventListener('show.bs.offcanvas', function () {
            loadWishlistItems();
        });

        

        // --- 3. BUTTONS (Cart Page) ---
        document.getElementById('remove-selected')?.addEventListener('click', function () {
            const selectedItems = getSelectedItems(); 
            window.removeCartItems(selectedItems);
        });
        
        document.getElementById('buy-selected')?.addEventListener('click', function () {
            const selectedItems = getSelectedItems(); 
            if (selectedItems.length > 0) {
                const itemsParam = selectedItems.join(',');
                window.location.href = `/checkouts?items=${itemsParam}`;
            } else {
                alert("Please select at least one item to checkout.");
            }
        });

        // --- 4. SCROLL TRANSITIONS (Product Detail Page) ---
        const floatingInfo = document.getElementById('floating-info');
        const relatedProducts = document.getElementById('related-products');

        if (floatingInfo && relatedProducts) {
            const observerOptions = { threshold: 0.01 };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        floatingInfo.style.opacity = '0';
                        floatingInfo.style.transform = 'translateY(-20px)';
                        floatingInfo.style.pointerEvents = 'none';
                    } else {
                        floatingInfo.style.opacity = '1';
                        floatingInfo.style.transform = 'translateY(0)';
                        floatingInfo.style.pointerEvents = 'all';
                    }
                });
            }, observerOptions);

            observer.observe(relatedProducts);
        }

        // --- 5. ORDER HISTORY LOGIC ---
        const detailContainers = document.querySelectorAll('.collapse');
        detailContainers.forEach(container => {
            // When the details open
            container.addEventListener('show.bs.collapse', function () {
                const orderId = this.id.split('-')[1];
                const btn = document.querySelector(`[data-bs-target="#details-${orderId}"]`);
                if (btn) {
                    btn.innerHTML = 'HIDE DETAILS <i class="bi bi-chevron-up"></i>';
                }
            });

            // When the details close
            container.addEventListener('hide.bs.collapse', function () {
                const orderId = this.id.split('-')[1];
                const btn = document.querySelector(`[data-bs-target="#details-${orderId}"]`);
                if (btn) {
                    btn.innerHTML = 'VIEW DETAILS <i class="bi bi-chevron-down"></i>';
                }
            });
        });
    });

    // --- 6. SNACKBAR / TOAST ---
    window.notify = function(message, type = 'success') {
        const container = document.getElementById('snackbar-container');
        if (!container) return;

        const snack = document.createElement('div');
        snack.className = `snackbar snackbar-${type}`;
        snack.role = 'status';
        snack.textContent = message;
        snack.addEventListener('click', () => snack.remove());
        container.appendChild(snack);

        // Allow transition
        requestAnimationFrame(() => snack.classList.add('show'));

        setTimeout(() => {
            snack.classList.remove('show');
            setTimeout(() => snack.remove(), 200);
        }, 3500);
    };
</script>

{% with messages = get_flashed_messages(with_categories=true) %}
<script id="flashed-json" type="application/json">{{ messages|tojson }}</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    try {
        const raw = document.getElementById('flashed-json')?.textContent || '[]';
        const flashed = JSON.parse(raw);
        flashed.forEach(function(item){
            const category = item[0] || 'info';
            const text = item[1] || '';
            if (text) window.notify(text, category);
        });
    } catch(e) {}
});
 </script>
{% endwith %}
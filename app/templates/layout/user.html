<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Wagging Wonders</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Darumadrop+One&family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg px-4">
        <div class="container-fluid">
            <a class="navbar-brand mx-auto d-flex align-items-center py-0" href="/">
            <span class="logo-text">Wagging Wonders</span>
        </a>


        <form class="d-flex flex-grow-1 justify-content-center ">
            <div class="input-group" style="max-width: 600px; width: 100%;">
                <span class="input-group-text"><i class="bi-search"></i></span>
                <input type="search" name="" id="" class="form-control text-start" placeholder="Search" >
            </div>
        </form>
        
        <div class="d-flex align-items-center">
            <ul class="navbar-nav d-flex flex-row gap-3">
                {% if session.get('user_id') and session.get('role') == 'user' %}
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="offcanvas" data-bs-target="#wishlistSidebar">
                        <i class="bi bi-heart fs-5 text-danger"></i>
                    </a>
                </li>

                <li class="nav-item">
                    <a href="#" class="nav-link" data-bs-toggle="offcanvas" data-bs-target="#cartSidebar"
                        aria-controls="cartSidebar">
                        <i class="bi bi-cart fs-5"></i>
                        <span id="cart-count" class="badge position-absolute top-50 mt-2 translate-middle rounded-pill bg-danger">
                            {{ cart_count or 0 }}
                        </span>
                    </a>
                </li>
                
                
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            {{ session.get('name') or 'User' }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="offcanvas" data-bs-target="#ordersSidebar">My Orders</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="offcanvas" data-bs-target="#historySidebar">My History</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="offcanvas" data-bs-target="#reviewsSidebar">My Reviews</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="{{ url_for('user.user_logout') }}">Logout</a></li>
                        </ul>
                    </li>
                
                {% else %}
                <li class="nav-item">
                    <a class="nav-link" href="/">
                        <i class="bi bi-box-arrow-in-right"></i> Login
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
        </div>
    </nav>

    <!-- Wishlist Sidebar (Offcanvas) -->
    <div class="offcanvas offcanvas-end d-flex flex-column" tabindex="-1" id="wishlistSidebar" aria-labelledby="wishlistSidebarLabel" style="width: 400px; color: #6a705d !important">
        <div class="offcanvas-header border-bottom">
            <h5 class="logo-text mb-0" style="color: #6a705d;" id="wishlistSidebarLabel">My Wishlist</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>

        <div class="px-4 py-2 bg-light border-bottom d-flex justify-content-between small fw-bold text-muted">
            <span style="color: #6a705d;">SAVED PRODUCTS</span>
        </div>

        <div class="offcanvas-body flex-grow-1" id="wishlist-items" style="overflow-y: auto;">
            </div>

        <div class="offcanvas-footer border-top p-3 bg-white">
            <div class="d-grid gap-2">
                <button class="btn py-2 fw-bold" style="background-color: #6a705d; color: white;" data-bs-dismiss="offcanvas">
                    CONTINUE SHOPPING
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Sidebar (Offcanvas) -->
    <div class="offcanvas offcanvas-end d-flex flex-column" tabindex="-1" id="cartSidebar" aria-labelledby="cartSidebarLabel" style="width: 400px; color: #6a705d !important">
        <div class="offcanvas-header border-bottom">
            <h5 class="logo-text mb-0" style="color: #6a705d;" id="cartSidebarLabel">Your Cart</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>

        <div class="px-4 py-2 bg-light border-bottom d-flex justify-content-between small fw-bold text-muted">
            <span style="color: #6a705d;">PRODUCT</span>
            <span style="color: #6a705d;">TOTAL</span>
        </div>

        <div class="offcanvas-body flex-grow-1" id="cart-items" style="overflow-y: auto;">
            </div>

        <div class="offcanvas-footer border-top p-3 bg-white">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="fw-bold h5 mb-0">Estimated Total:</span>
                <span class="fw-bold h5 mb-0" style="color: #CB997E;">â‚±<span id="cart-total-price">0.00</span></span>
            </div>
            
            <div class="d-grid gap-2">
                <button class="btn py-2 fw-bold" id="buy-selected" style="color: white; display: none;">
                    CHECKOUT SELECTED
                </button>
                <button class="btn btn-sm btn-outline-danger" id="remove-selected" style="display: none;">
                    Remove Selected
                </button>
            </div>
        </div>
    </div>


    <!-- Order Confirmation Modal -->
    <div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="border-radius: 1rem; background-color: #f6f6f6;">
                <div class="modal-header"
                    style="background-color: #6a705d; color: white; border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
                    <h5 class="modal-title" id="orderModalLabel">ðŸ§¾ Order Confirmation</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5 class="mb-3" style="color: #5A604D; font-weight: bold;">Items to be purchased:</h5>
                    <div id="order-details"
                        style="background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <!-- Order items will be dynamically filled here -->
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="mb-0" style="font-size: 1.25rem; color: #333;"><strong>Total Amount:</strong></p>
                        <p class="mb-0" style="font-size: 1.5rem; color: #CB997E;"><strong>â‚±<span
                                    id="total-price">0</span></strong></p>
                    </div>
                    <p class="mt-2" style="color: #6a705d;"><strong>Payment Method:</strong> Cash on Delivery</p>
                </div>
                <div class="modal-footer"
                    style="background-color: #FCFCFC; border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem;">
                    <button type="button" class="btn btn-outline-secondary px-4 py-2" data-bs-dismiss="modal"
                        style="border-radius: 0.5rem;">Cancel</button>
                    <button type="button" class="btn px-4 py-2" id="confirmOrder"
                        style="background-color: #CB997E; color: white; border-radius: 0.5rem;">Place Order</button>
                </div>
            </div>
        </div>
    </div>



    <div class="offcanvas offcanvas-end" tabindex="-1" id="ordersSidebar" aria-labelledby="ordersSidebarLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="ordersSidebarLabel">My Orders</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <!-- Order details will be loaded here dynamically -->
            <div id="my-orders">
                <!-- Ongoing and completed orders -->
            </div>
        </div>
    </div>

    <!-- History Sidebar -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="historySidebar" aria-labelledby="historySidebarLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="historySidebarLabel">My History</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div id="my-history">
                <!-- Completed orders will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Reviews Sidebar -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="reviewsSidebar" aria-labelledby="reviewsSidebarLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="reviewsSidebarLabel">My Reviews</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div id="my-reviews">
                <!-- Reviews will be loaded here dynamically -->
            </div>
        </div>
    </div>



    <main class="">
        {% block content %}{% endblock %}
    </main>

    {% block scripts %}{% endblock %}

</body>

</html>

<script>

    // --- 1. GLOBAL FUNCTIONS ---
    
    window.loadWishlistItems = function() {
        fetch("/wishlist/items") // You will create this route next
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('wishlist-items');
            container.innerHTML = ''; 

            if (data.length > 0) {
                data.forEach(item => {
                    container.innerHTML += `
                        <div class="card mb-3 shadow-sm border rounded bg-light p-2" style="border-color: #6a705d !important;">
                            <div class="card-body d-flex justify-content-between p-1">
                                <img src="/static/${item.image}" class="rounded" style="object-fit:cover; width:80px; height:80px;">
                                <div class="d-flex flex-column flex-grow-1 px-3">
                                    <p class="fw-semibold mb-0" style="color: #6a705d;">${item.name}</p>
                                    <p class="fw-bold mb-2" style="color: #CB997E;">â‚±${item.price.toLocaleString()}</p>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm text-white" style="background-color: #CB997E;" onclick="addToCartFromWishlist(${item.product_id})">
                                            <i class="bi bi-cart-plus"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="toggleWishlist(${item.product_id}, null)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });
            } else {
                container.innerHTML = `<div class="text-center py-5 text-muted"><i class="bi bi-heart fs-1"></i><p>Your wishlist is empty</p></div>`;
            }
        });
    };

    // Function to update the number shown in the PDP input field
    window.adjustPDPQuantity = function(change) {
        const qtyInput = document.getElementById('pdp-quantity');
        let currentQty = parseInt(qtyInput.value);
        let newQty = currentQty + change;

        // Prevent quantity from going below 1
        if (newQty >= 1) {
            qtyInput.value = newQty;
        }
    };

    // Function to call the UPSERT logic with the chosen quantity
    window.addToCartFromPDP = function(productId) {
        const qty = parseInt(document.getElementById('pdp-quantity').value);
        
        // Use your existing upSert function
        // mode 'add' ensures it adds to the current cart quantity
        window.upSert(productId, qty, 'add');
        
        // Optional: Reset quantity to 1 after adding
        document.getElementById('pdp-quantity').value = 1;
    };
    // Helper to move item to cart and refresh both sidebars
    window.addToCartFromWishlist = function(productId) {
        upSert(productId, 1, 'add'); 
    };

    // This function handles BOTH single trash icon clicks AND the bulk remove button
    // UPDATED: Now updates ALL hearts on the page instantly after toggle
    window.toggleWishlist = function(productId, btnElement) {
        fetch(`/wishlist/toggle/${productId}`, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) throw new Error('Not logged in');
            return response.json();
        })
        .then(data => {
            // 1. Update the Icon on the Product Card (if btnElement exists)
            if (btnElement) {
                const icon = btnElement.querySelector('i');
                if (data.status === 'added') {
                    icon.classList.replace('bi-heart', 'bi-heart-fill');
                } else {
                    icon.classList.replace('bi-heart-fill', 'bi-heart');
                }
            }

            // 2. Update ALL heart icons for this product ID on the page
            const isWishlisted = data.is_wishlisted;
            const newIconClass = isWishlisted ? 'bi-heart-fill' : 'bi-heart';
            document.querySelectorAll(`i[data-product-id="${productId}"]`).forEach(icon => {
                icon.classList.remove('bi-heart', 'bi-heart-fill');
                icon.classList.add(newIconClass);
            });

            // 3. Check if the Wishlist Sidebar is currently open
            const wishlistSidebar = document.getElementById('wishlistSidebar');
            if (wishlistSidebar && wishlistSidebar.classList.contains('show')) {
                // Re-fetch the list so the item disappears from the sidebar immediately
                loadWishlistItems();
            }
        })
        .catch(err => {
            alert("Please login to manage your wishlist!");
            window.location.href = "/login";
        });
    };

    window.removeCartItems = function(idList) {
        if (!idList || idList.length === 0) {
            alert("Please select items to remove.");
            return;
        }

        if (confirm("Are you sure you want to remove the selected item(s)?")) {
            $.ajax({
                url: '/cart/items/remove-selected',
                method: 'POST',
                // Ensure data key matches the Python getlist('selected_items[]')
                data: { 'selected_items[]': idList }, 
                success: function () {
                    loadCartItems();
                },
                error: function () {
                    alert('Failed to remove items.');
                }
            });
        }
    };

    // Wrapper for the trash icon onclick attribute
    window.removeSingleItem = function(id) {
        window.removeCartItems([id]); // Wraps the single ID in an array
    };

    // The Single Source of Truth for Cart Changes
    window.upSert = function(productId, qty, mode) {
        let formData = new FormData();
        formData.append('product_id', productId);
        formData.append('quantity', qty);
        formData.append('mode', mode); // 'add' (increment) or 'set' (overwrite)

        fetch('/cart/items/upsert', { 
            method: 'POST', 
            body: formData 
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadCartItems(); // Refresh the UI
            } else {
                alert(data.error || "Action failed");
            }
        })
        .catch(err => console.error("Cart Error:", err));
    }

    // Logic for Sidebar +/- Buttons
    window.updateQuantity = function(cartId, productId, action) {
        const quantityInput = document.getElementById('quantity-' + cartId);
        if (!quantityInput) return;

        let currentQuantity = parseInt(quantityInput.value);
        let newQuantity = (action === 'increase') ? currentQuantity + 1 : currentQuantity - 1;

        if (newQuantity >= 1) {
            // We use 'set' mode here to overwrite the DB with the new exact number
            window.upSert(productId, newQuantity, 'set');
        }
    };

    window.toggleSelection = function() {
        const selectedCount = document.querySelectorAll('.select-item:checked').length;
        const removeButton = document.getElementById('remove-selected');
        const buyButton = document.getElementById('buy-selected');
        
        if(removeButton && buyButton) {
            const displayStyle = selectedCount > 0 ? 'inline-block' : 'none';
            removeButton.style.display = displayStyle;
            buyButton.style.display = displayStyle;
        }
    };

    window.getSelectedItems = function() {
        return Array.from(document.querySelectorAll('.select-item:checked')).map(cb => cb.getAttribute('data-id'));
    };

    // --- 2. LOADERS ---

    function loadCartItems() {
        $.ajax({
            url: "{{ url_for('user.cart_items') }}",
            method: 'GET',
            success: function (response) {
                const cartItemsContainer = document.getElementById('cart-items');
                const cartCountBadge = document.getElementById('cart-count');
                const totalDisplay = document.getElementById('cart-total-price');
                
                let total = 0;
                let itemCount = 0;
                cartItemsContainer.innerHTML = ''; 
                
                if (response && response.length > 0) {
                    response.forEach(item => {
                        total += item.price * item.quantity;
                        itemCount += item.quantity;
                        const imagePath = `/static/${item.image}`; 
                        cartItemsContainer.innerHTML += ` 
                            <div class="d-flex flex-row align-items-center mb-3">
                                <div class="form-check me-2">
                                    <input type="checkbox" class="form-check-input select-item fs-5" data-id="${item.id}" onchange="toggleSelection()">
                                </div>
                                <div class="card shadow-sm border rounded bg-light p-2 flex-grow-1" style="border-color: #6a705d !important; color: #6a705d !important;">
                                    <div class="card-body d-flex justify-content-between p-1">
                                        <img src="${imagePath}" class="rounded" style="object-fit:cover; width:80px; height:80px;">
                                        <div class="d-flex flex-column flex-grow-1 px-3">
                                            <p class="fw-semibold mb-0">${item.name}</p>
                                            <p class="fw-normal small mb-2">â‚±${item.price}</p>
                                            <div class="d-flex flex-row align-items-center">
                                                <div class="input-group input-group-sm border rounded" style="max-width: 100px; border-color: #6a705d !important;">
                                                    <button class="btn btn-sm" onclick="updateQuantity(${item.id}, ${item.product_id}, 'decrease')">-</button>
                                                    <input type="text" id="quantity-${item.id}" class="form-control text-center border-0 bg-transparent" value="${item.quantity}" readonly>
                                                    <button class="btn btn-sm" onclick="updateQuantity(${item.id}, ${item.product_id}, 'increase')">+</button>
                                                </div>
                                                <button class="btn btn-link p-0 ms-2" onclick="removeSingleItem(${item.id})">
                                                    <i class="bi bi-trash fs-5 text-danger"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="text-end fw-medium">â‚±${(item.price * item.quantity).toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>`;
                    });
                    totalDisplay.textContent = total.toFixed(2);
                    cartCountBadge.textContent = itemCount;
                } else {
                    cartItemsContainer.innerHTML = `<div class="text-center py-5 text-muted"><i class="bi bi-cart-x fs-1"></i><p>Your cart is empty</p></div>`;
                    totalDisplay.textContent = "0.00";
                    cartCountBadge.textContent = "0";
                }
                toggleSelection();
            }
        });
    }

    // --- 3. DOM READY ---

    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. CART & WISHLIST INITIALIZATION ---
        loadCartItems();

        const wishlistSidebar = document.getElementById('wishlistSidebar');
        wishlistSidebar?.addEventListener('show.bs.offcanvas', function () {
            loadWishlistItems();
        });

        

        // --- 3. BUTTONS (Cart Page) ---
        document.getElementById('remove-selected')?.addEventListener('click', function () {
            const selectedItems = getSelectedItems(); 
            window.removeCartItems(selectedItems);
        });
        
        document.getElementById('buy-selected')?.addEventListener('click', function () {
            const selectedItems = getSelectedItems(); 
            if (selectedItems.length > 0) {
                const itemsParam = selectedItems.join(',');
                window.location.href = `/checkouts?items=${itemsParam}`;
            } else {
                alert("Please select at least one item to checkout.");
            }
        });

        // --- 4. SCROLL TRANSITIONS (Product Detail Page) ---
        const floatingInfo = document.getElementById('floating-info');
        const relatedProducts = document.getElementById('related-products');

        if (floatingInfo && relatedProducts) {
            const observerOptions = { threshold: 0.01 };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        floatingInfo.style.opacity = '0';
                        floatingInfo.style.transform = 'translateY(-20px)';
                        floatingInfo.style.pointerEvents = 'none';
                    } else {
                        floatingInfo.style.opacity = '1';
                        floatingInfo.style.transform = 'translateY(0)';
                        floatingInfo.style.pointerEvents = 'all';
                    }
                });
            }, observerOptions);

            observer.observe(relatedProducts);
        }
    });
</script>